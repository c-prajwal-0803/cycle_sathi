<script>
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function registerUser(){
  const e=signEmail.value.trim(),p=signPass.value,c=signConf.value;
  if(!e||!p){alert("Fill all fields");return;}
  if(p!==c){alert("Passwords donâ€™t match");return;}
  localStorage.setItem("userEmail",e);
  localStorage.setItem("userPass",p);
  alert("Sign-up successful!");
  showScreen("screen2");
}

function loginUser(){
  const e=loginEmail.value.trim(),p=loginPass.value,
        se=localStorage.getItem("userEmail"),
        sp=localStorage.getItem("userPass");
  if(e===se&&p===sp){
    alert("Login successful!");
    localStorage.setItem("currentUser",e);
    const hasData=localStorage.getItem(e+"_name")||localStorage.getItem(e+"_records");
    if(!hasData)resetAllData();
    showScreen("home");
    loadUserData(e);
  }else alert("Invalid credentials.");
}

function logout(){
  alert("Logged out successfully!");
  showScreen("screen2");
  localStorage.removeItem("currentUser");
}

function showSection(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active-section"));
  document.getElementById(id).classList.add("active-section");
}

/* === SAVE PROFILE (now saves vitals too) === */
function saveProfile(){
  const email=localStorage.getItem("currentUser");
  if(!email)return alert("Login first.");
  const prefix=email+"_";

  // Save profile info
  ["name","age","gender","cycleLen","allergies","conditions","notes"].forEach(id=>{
    localStorage.setItem(prefix+id,document.getElementById(id).value);
  });

  // Save vitals data
  ["heart","o2","moves","temp"].forEach(id=>{
    localStorage.setItem(prefix+id,document.getElementById(id).value);
  });

  alert("Profile & vitals saved!");
  addRecord("profile",{
    Name:name.value,
    Age:age.value,
    Gender:gender.value,
    Cycle_Length:cycleLen.value,
    Allergies:allergies.value,
    Conditions:conditions.value,
    Notes:notes.value,
    Heart_Rate:heart.value,
    O2:o2.value,
    Movement:moves.value,
    Temperature:temp.value
  });
}

function saveSymptoms(){
  const email=localStorage.getItem("currentUser");
  if(!email){alert("Login first.");return;}
  const prefix=email+"_",start=startDate.value;
  if(!start)return alert("Select Start Date");
  const sd=new Date(start),addDays=d=>new Date(sd.getTime()+d*86400000).toLocaleDateString();
  nextPeriod.value=addDays(28);
  ovulation.value=addDays(14);
  fertile.value=`${addDays(10)} to ${addDays(15)}`;
  ["startDate","endDate","flow","pain","periodColor"].forEach(id=>
    localStorage.setItem(prefix+id,document.getElementById(id).value)
  );
  alert("Symptoms saved!");
  addRecord("track",{
    Name:name.value||localStorage.getItem(prefix+"name")||"(no name)",
    Start_Date:startDate.value,
    End_Date:endDate.value,
    Flow:flow.value,
    Pain_Level:pain.value,
    Period_Colour:periodColor.value,
    Next_Period:nextPeriod.value,
    Ovulation:ovulation.value,
    Fertile_Window:fertile.value
  });
}

function addRecord(type,data){
  const email=localStorage.getItem("currentUser");
  if(!email)return;
  const prefix=email+"_",
        records=JSON.parse(localStorage.getItem(prefix+"records")||"[]");
  records.push({type,data,time:new Date().toLocaleString()});
  localStorage.setItem(prefix+"records",JSON.stringify(records));
  loadRecords(email);
}

function loadRecords(email){
  const tbody=document.getElementById("recordsTableBody");
  if(!tbody)return;
  const prefix=email+"_",
        records=JSON.parse(localStorage.getItem(prefix+"records")||"[]").reverse();
  if(!records.length)
    return tbody.innerHTML=`<tr><td colspan='3' class='text-center text-muted'>No records yet</td></tr>`;
  tbody.innerHTML=records.map(r=>{
    const body=Object.entries(r.data).map(([k,v])=>
      k==="Period_Colour"
        ? `<div><strong>${k}</strong>: <span style="display:inline-block;width:18px;height:18px;background:${v};border:1px solid #ccc;margin-left:5px;"></span></div>`
        : `<div><strong>${k}</strong>: ${v||"-"}</div>`
    ).join("");
    return `<tr><td>${r.time}</td><td>${r.type==="track"?"Cycle Tracking":"Profile"}</td><td>${body}</td></tr>`;
  }).join("");
}

/* === AI Ask Function === */
async function askQuestion() {
  const q = question.value.trim();
  if (!q) return alert("Enter a question.");
  answer.value = "Thinking...";

  try {
    const res = await fetch("http://localhost:3000/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: q })
    });

    const data = await res.json();
    answer.value =
      data?.[0]?.generated_text ||
      data?.generated_text ||
      "Sorry, I couldn't find an answer right now.";
  } catch (err) {
    console.error(err);
    answer.value = "Error contacting proxy server.";
  }
}

function speakAnswer(){
  const t=answer.value;
  if(!t)return alert("No answer to read.");
  const u=new SpeechSynthesisUtterance(t);
  u.rate=1;u.pitch=1;
  speechSynthesis.speak(u);
}

function resetAllData(){
  ["name","age","gender","cycleLen","allergies","conditions","notes",
   "startDate","endDate","flow","pain","periodColor",
   "nextPeriod","ovulation","fertile","question","answer"]
   .forEach(id=>{
     const el=document.getElementById(id);
     if(el){
       if(el.tagName==="SELECT")el.selectedIndex=0;
       else if(el.type==="color")el.value="#ff8fa3";
       else el.value="";
     }
   });
  ["heart","o2","moves","temp"].forEach(id=>{
    const e=document.getElementById(id);
    if(e) e.value="";
  });
  document.getElementById("recordsTableBody").innerHTML=
    `<tr><td colspan="3" class='text-center text-muted'>No records yet</td></tr>`;
}

/* === LOAD USER DATA (now loads vitals too) === */
function loadUserData(email){
  const prefix=email+"_";
  ["name","age","gender","cycleLen","allergies","conditions","notes"]
    .forEach(id=>document.getElementById(id).value="");
  document.getElementById("periodColor").value="#ff8fa3";

  ["name","age","gender","cycleLen","allergies","conditions","notes","heart","o2","moves","temp"]
    .forEach(id=>{
      const v=localStorage.getItem(prefix+id);
      if(v) document.getElementById(id).value=v;
    });

  const pc=localStorage.getItem(prefix+"periodColor");
  if(pc) document.getElementById("periodColor").value=pc;
  loadRecords(email);
}

/* === Fetch and update ESP8266 sensor data === */
async function updateSensors() {
  try {
    const res = await fetch("http://192.168.1.57/data"); // <-- your ESP8266 IP
    if (!res.ok) throw new Error("Bad response");
    const d = await res.json();
    document.getElementById("heart").value = d.heart_rate?.toFixed(1) ?? "0";
    document.getElementById("temp").value = d.temperature?.toFixed(1) ?? "0";
    document.getElementById("moves").value = d.movement?.toFixed(2) ?? "0";
    document.getElementById("o2").value = "80"; // placeholder
  } catch (err) {
    console.warn("ESP8266 fetch error:", err.message);
    document.getElementById("heart").value = "60";
    document.getElementById("temp").value = "38";
    document.getElementById("moves").value = "0.96";
    document.getElementById("o2").value = "77";
  }
}
updateSensors();
setInterval(updateSensors, 3000);
</script>
